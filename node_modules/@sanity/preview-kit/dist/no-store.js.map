{"version":3,"file":"no-store.js","sources":["../src/no-store.ts"],"sourcesContent":["// This is the default, fallback store, that allows using useLiveQuery without a provider.\nimport type { QueryParams } from '@sanity/client'\n\nimport type {\n  DefineListenerContext,\n  ListenerGetSnapshot,\n  ListenerSubscribe,\n} from './types'\nimport { getQueryCacheKey, type QueryCacheKey } from './utils'\n\nconst snapshots = new Map<QueryCacheKey, unknown>()\nconst deps = new Map<QueryCacheKey, number>()\n\n/**\n * @internal\n */\nexport const NoStoreContext = function defineListener<QueryResult>(\n  initialSnapshot: QueryResult,\n  query: string,\n  params: QueryParams,\n) {\n  const key = getQueryCacheKey(query, params)\n\n  // Always update the snapshot, to ensure that we have the latest value\n  snapshots.set(key, initialSnapshot)\n  // Keep track of how many dependencies are using this query, so we can know when it's safe to cleanup\n  if (!deps.has(key)) {\n    deps.set(key, 0)\n  }\n\n  const subscribe: ListenerSubscribe = () => {\n    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n    deps.set(key, deps.get(key)! + 1)\n\n    return () => {\n      // Bookkeeping on how many dependencies are using this query\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      deps.set(key, deps.get(key)! - 1)\n\n      // If nothing cares about this snapshot, clean it up and free memory\n      if (deps.get(key) === 0) {\n        snapshots.delete(key)\n      }\n    }\n  }\n  const getSnapshot: ListenerGetSnapshot<QueryResult> = () =>\n    snapshots.has(key) ? (snapshots.get(key) as QueryResult) : initialSnapshot\n\n  return { subscribe, getSnapshot }\n} satisfies DefineListenerContext\n"],"names":["snapshots","Map","deps","NoStoreContext","defineListener","initialSnapshot","query","params","key","getQueryCacheKey","set","has","subscribe","get","delete","getSnapshot"],"mappings":";AAUA,MAAMA,SAAA,GAAA,mBAAgBC,GAA4B,EAAA;AAClD,MAAMC,IAAA,GAAA,mBAAWD,GAA2B,EAAA;AAKrC,MAAME,cAAiB,GAAA,SAASC,cACrCA,CAAAC,eAAA,EACAC,OACAC,MACA,EAAA;EACM,MAAAC,GAAA,GAAMC,gBAAiB,CAAAH,KAAA,EAAOC,MAAM,CAAA;EAGhCP,SAAA,CAAAU,GAAA,CAAIF,KAAKH,eAAe,CAAA;EAElC,IAAI,CAACH,IAAA,CAAKS,GAAI,CAAAH,GAAG,CAAG,EAAA;IACbN,IAAA,CAAAQ,GAAA,CAAIF,KAAK,CAAC,CAAA;EACjB;EAEA,MAAMI,YAA+BA,CAAA,KAAM;IAEzCV,IAAA,CAAKQ,IAAIF,GAAK,EAAAN,IAAA,CAAKW,GAAI,CAAAL,GAAG,IAAK,CAAC,CAAA;IAEhC,OAAO,MAAM;MAGXN,IAAA,CAAKQ,IAAIF,GAAK,EAAAN,IAAA,CAAKW,GAAI,CAAAL,GAAG,IAAK,CAAC,CAAA;MAGhC,IAAIN,IAAK,CAAAW,GAAA,CAAIL,GAAG,CAAA,KAAM,CAAG,EAAA;QACvBR,SAAA,CAAUc,OAAON,GAAG,CAAA;MACtB;IAAA,CACF;EAAA,CACF;EACM,MAAAO,WAAA,GAAgDA,CAAA,KACpDf,SAAU,CAAAW,GAAA,CAAIH,GAAG,CAAK,GAAAR,SAAA,CAAUa,GAAI,CAAAL,GAAG,CAAoB,GAAAH,eAAA;EAEtD,OAAA;IAAEO;IAAWG;GAAY;AAClC,CAAA;"}