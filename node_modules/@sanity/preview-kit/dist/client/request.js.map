{"version":3,"file":"request.js","sources":["../../src/client/request.ts"],"sourcesContent":["/**\n * Creates a custom `httpRequest` handler for `SanityClient`, that\n * includes a middleware that handles source maps and stega encoding.\n */\nimport {\n  type HttpRequest,\n  requester as originalRequester,\n  type RequestOptions,\n} from '@sanity/client'\nimport isPlainObject from 'lodash.isplainobject'\n\nimport { createTranscoder } from '../csm/transcode'\nimport type {\n  ContentSourceMapQueryResponse,\n  PreviewKitClientConfig,\n} from './types'\n\ntype TranscodeResponseConfig = Pick<\n  PreviewKitClientConfig,\n  'studioUrl' | 'encodeSourceMapAtPath' | 'logger'\n>\n\nfunction transcodeResponse({\n  studioUrl,\n  encodeSourceMapAtPath,\n  logger,\n}: TranscodeResponseConfig) {\n  // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n  const transcoder = createTranscoder({\n    studioUrl: studioUrl!,\n    encodeSourceMapAtPath,\n    logger: logger!,\n  })\n  return {\n    onResponse: (response: unknown) => {\n      if (!isBodyResponse(response)) {\n        return response\n      }\n\n      if (\n        Array.isArray(response.body) ||\n        typeof response.body === 'string' ||\n        isPlainObject(response.body)\n      ) {\n        if (!isContentSourceMapBody(response.body)) {\n          if (logger && isResultBody(response.body)) {\n            logger?.error?.(\n              '[@sanity/preview-kit]: Missing Content Source Map from response body',\n              response.body,\n            )\n          }\n          return response\n        }\n\n        const transcoderResult = transcoder(\n          response.body.result,\n          response.body.resultSourceMap!,\n        )\n\n        if (logger) {\n          const isSkipping = transcoderResult.report.skipped.length\n          const isEncoding = transcoderResult.report.encoded.length\n          if (isSkipping || isEncoding) {\n            // eslint-disable-next-line @typescript-eslint/no-extra-semi\n            ;(logger?.groupCollapsed || logger.log)?.(\n              '[@sanity/preview-kit]: Stega encoding source map into result',\n            )\n            logger.log?.(\n              `[@sanity/preview-kit]: Paths encoded: ${transcoderResult.report.encoded.length}, skipped: ${transcoderResult.report.skipped.length}`,\n            )\n          }\n          if (transcoderResult.report.encoded.length > 0) {\n            logger?.log?.(`[@sanity/preview-kit]: Table of encoded paths`)\n            ;(logger?.table || logger.log)?.(transcoderResult.report.encoded)\n          }\n          if (transcoderResult.report.skipped.length > 0) {\n            const skipped = new Set<string>()\n            for (const { path } of transcoderResult.report.skipped) {\n              skipped.add(path.replace(/\\[\\d+\\]/g, '[]'))\n            }\n            logger?.log?.(`[@sanity/preview-kit]: List of skipped paths`, [\n              ...skipped.values(),\n            ])\n          }\n\n          if (isSkipping || isEncoding) {\n            logger?.groupEnd?.()\n          }\n        }\n\n        const body = {\n          ...response.body,\n          result: transcoderResult.result,\n        }\n        return { ...response, body }\n      }\n\n      return response\n    },\n  }\n}\n\n/** @internal */\nexport function createHttpRequest({\n  studioUrl,\n  encodeSourceMapAtPath,\n  logger,\n}: Pick<\n  PreviewKitClientConfig,\n  'studioUrl' | 'encodeSourceMapAtPath' | 'logger'\n>): HttpRequest {\n  const superRequester = originalRequester.clone()\n\n  // Apply the transcoder middleware\n  superRequester.use(\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any -- support the improved get-it typings\n    transcodeResponse({ studioUrl, encodeSourceMapAtPath, logger }) as any,\n  )\n\n  function httpRequest(\n    options: RequestOptions,\n    requester = superRequester,\n  ): HttpRequest {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    return requester({ maxRedirects: 0, ...options } as any)\n  }\n\n  httpRequest.defaultRequester = superRequester\n\n  return httpRequest\n}\n\nfunction isBodyResponse(response: unknown): response is { body?: unknown } {\n  return typeof response === 'object' && response !== null\n}\n\n/** @alpha */\nexport function isResultBody(\n  body: unknown,\n): body is ContentSourceMapQueryResponse {\n  return typeof body === 'object' && body !== null && 'result' in body\n}\n\n/** @alpha */\nexport function isContentSourceMapBody(\n  body: unknown,\n): body is ContentSourceMapQueryResponse {\n  return typeof body === 'object' && body !== null && 'resultSourceMap' in body\n}\n"],"names":["transcodeResponse","_ref","studioUrl","encodeSourceMapAtPath","logger","transcoder","createTranscoder","onResponse","response","_a","_b","_c","_d","_e","_f","_g","isBodyResponse","Array","isArray","body","isPlainObject","isContentSourceMapBody","isResultBody","error","call","transcoderResult","result","resultSourceMap","isSkipping","report","skipped","length","isEncoding","encoded","groupCollapsed","log","concat","table","Set","path","add","replace","values","groupEnd","createHttpRequest","_ref2","superRequester","originalRequester","clone","use","httpRequest","options","requester","arguments","undefined","maxRedirects","defaultRequester"],"mappings":"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"}